<!DOCTYPE html>
<html lang="en">

<head>
    <title>Family Board</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <script src="/static/lib/signalr/signalr.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/board.css" />
</head>

<body>

    <div class="board">

        <div id="imageContainer" style="overflow: hidden;">
        </div>

        <div class="main">

            <div class="calendar">

                <div class="weekday">Mo</div>
                <div class="weekday">Di</div>
                <div class="weekday">Mi</div>
                <div class="weekday">Do</div>
                <div class="weekday">Fr</div>
                <div class="weekday">Sa</div>
                <div class="weekday">So</div>

                <div id="day0" class="day">
                </div>
                <div id="day1" class="day">
                </div>
                <div id="day2" class="day">
                </div>
                <div id="day3" class="day">
                </div>
                <div id="day4" class="day">
                </div>
                <div id="day5" class="day">
                </div>
                <div id="day6" class="day">
                </div>

                <div id="day7" class="day">
                </div>
                <div id="day8" class="day">
                </div>
                <div id="day9" class="day">
                </div>
                <div id="day10" class="day">
                </div>
                <div id="day11" class="day">
                </div>
                <div id="day12" class="day">
                </div>
                <div id="day13" class="day">
                </div>

                <div id="day14" class="day">
                </div>
                <div id="day15" class="day">
                </div>
                <div id="day16" class="day">
                </div>
                <div id="day17" class="day">
                </div>
                <div id="day18" class="day">
                </div>
                <div id="day19" class="day">
                </div>
                <div id="day20" class="day">
                </div>


            </div>

            <div id="message">
            </div>

        </div>

    </div>

    <script type="text/javascript">
        function currentDate() {
            let current = new Date();
            current.setHours(0, 0, 0, 0)
            return current;
        }

        $(document).ready(function () {

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/api")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.start().then(function () {
                console.log("connected");
            });

            connection.on('newMessage', newMessage);
            connection.on('updateCalendar', updateCalendar);
            connection.on('updateImage', updateImage);

            connection.onclose(() => console.log('disconnected'));

            function newMessage(message) {
                console.log(message);
                putMessage(message.Text);
            }

            // --------------------------------------------------------------------------------
            // put a message
            function putMessage(message, timeoutSecs) {
                $("#message").html(message);
                if (timeoutSecs) {
                    setTimeout(() => {
                        $("#message").html("");
                    }, timeoutSecs * 1000);
                }
            }

            // --------------------------------------------------------------------------------
            // update calendar
            function updateCalendar(events) {
                putMessage("updating calendar");

                // find first day of week
                let current = currentDate();

                let wd = current.getDay();
                let firstDate = currentDate();
                while (wd > 1) {
                    wd--;
                    firstDate.setDate(firstDate.getDate() - 1);
                }

                // fill calendar
                let iDate = currentDate();

                for (i = 0; i < 21; i++) {
                    iDate.setDate(firstDate.getDate() + i);

                    // reset
                    $("#day" + i).html("<div id='dayHeader'><div class='day_number'>" + iDate.getDate() + "</div></div><div id='dayContent'></div>");
                    $("#day" + i).removeClass("today").add("day");

                    // build cell content
                    let content = "";

                    let iDateFormatted = iDate.toISOString().split('T')[0];

                    // render all day events always on top
                    events.forEach((entry) => {
                        if (iDateFormatted === entry.date && entry.allDayEvent) {
                            content += "<div class='all_day'>" + entry.description + "</div>";
                        }
                    });

                    // render timed events below
                    events.forEach((entry) => {
                        if (iDateFormatted === entry.date && !entry.allDayEvent) {
                            content += "<p class='single_event'>" + entry.time + " " + entry.description + "</p>";
                        }
                    });

                    $("#day" + i + " > #dayContent").html(content);

                    if (iDate.toISOString() === current.toISOString()) {
                        $("#day" + i).toggleClass("today");
                    }
                }

                putMessage("calendar updated", 2);
            }

            // --------------------------------------------------------------------------------
            // update calendar
            function updateImage(imageData) {
                putMessage("updating image");
                console.log(imageData);
                var imageObj = JSON.parse(imageData);
                console.log(imageObj);
                //$("#image").attr("style","background-image: url('"  + imageUri + "');").html("<img src='" + imageUri + "' />");
                $("#imageContainer").html("<img id='image' style='position: relative;image-orientation: from-image;' src='" + imageObj.path + "' />");
                putMessage("image updated", 2);
            }
        });
    </script>


</body>

</html>