# Family or Kitchen Board based on Azure Functions and SignalR

> UNDER CONSTRUCTION

Inspired by the board used in [a post from Scott Hanselman](https://www.hanselman.com/blog/HowToBuildAWallMountedFamilyCalendarAndDashboardWithARaspberryPiAndCheapMonitor.aspx), the web application in this project shows information

- from a Google Calendar
- from an Outlook Calendar
- random images from OneDrive

and is called from a browser on a Rasberry Pi W to display this information in a comprehensive board.

## Technologies used

- [Azure (durable) Functions](https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview)
- [SignalR services](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-signalr-service)
- [Static pages hosted in Azure Functions - blog by Anthony Chu](https://anthonychu.ca/post/azure-functions-static-file-server/)
- Symetric encryption [- based on this post- ](https://tekeye.uk/visual_studio/encrypt-decrypt-c-sharp-string) of expiration date/time to protect API endpoint for access the latest availabe image

## Architecture

Front-end is based on static pages which are hosted from Consumption Plan Azure Functions (class `StaticFileServer`).

For basic protection `index.html` can only be opened with a Azure Functions key: `https://{function-app}.azurewebsites.net/index.html?code={key}`. All other static content is not protected.

Functions back-end uses Azure SignalR services to communicate board (calendar and image) changes to the web front-end.

### Board update flows

Various flows update the board and are either initiated when the default page `index.htm` is opened, a SignalR client connects or by scheduled timers.

#### Cient connect

When a new SignalR client connects, all contents of the board are updated:

| Function | Function Type |
| ---- | ---- |
| Negotiate | Http Trigger |
| -> FullBoardUpdate | Orchestration |
| - -> CheckConfigurationActivity | Activity Function |
| - -> RefreshGoogleTokenActivity | Activity Function |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> UpdateCalendarActivity | Activity Function |
| - -> RollImageActivity | Activity Function |
| - -> UpdateImageActivity | Activity Function |

#### Scheduled calendar update

Calendar is updated based on a scheduled trigger (e.g. each 5 mins):

| Function | Function Type |
| ---- | ---- |
| ScheduledCalendarUpdate | Trimer Trigger |
| -> CalendarUpdate | Orchestration |
| - -> RefreshGoogleTokenActivity | Activity Function |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> UpdateCalendarActivity | Activity Function |

#### Scheduled image update

Image is updated based on a scheduled trigger (e.g. each 1 mins):

| Function | Function Type |
| ---- | ---- |
| ScheduledImageUpdate | Trimer Trigger |
| -> ImageUpdate | Orchestration |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> RollImageActivity | Activity Function |
| - -> UpdateImageActivity | Activity Function |

### Access to Microsoft & Google APIs

Access to Outlook Calendar, OneDrive and Google Calendar API is handled with OAuth2.0 tokens where the access & refresh token is generated by calling the authorization endpoint and having a function storing the tokens in the associated storage account. Setup section below described how this credentials are setup and wired into the application.

## Limitations

- currently only fix 3 weeks model
- only German weekdays from Monday to Sunday
- public holidays for Germany, Baden-WÃ¼rttemberg

## Setup

...

### Application settings

These settings need to be set in the Azure Functions for the application to work properly:

| Appsetting | purpose | sample |
| ---- | ---- | ---- |
| APPINSIGHTS_INSTRUMENTATIONKEY | Application Insights instrumentation key |
| AzureSignalRConnectionString | Connection string used by SignalR binding to connect to SignalR service |
| AzureWebJobsStorage | Connectiong string required by Azure Functions / Web Jobs host |
| ENCRYPTION_INITVECTOR | Specifies a string used as an initial vector to encrypt the access key to the latest image provided by the ImageServer to the front-end (related to `IMAGE_PASSPHRASE`) |
| GOOGLE_CALENDAR_ID | calender id accessed over Google Calendar API | `john.doe@gmail.com` |
| GOOGLE_CLIENT_ID | client identifier for Google Calendar API OAuth2.0 access | `123456789012-abdefghijklmnopqrstuvwxyz01234567.apps.googleusercontent.com` |
| GOOGLE_CLIENT_SECRET | client secret for Google Calendar API OAuth2.0 access | `12345-AbCdEfGhIjKl-mNoPqRsTuV` |
| GOOGLE_REDIRECT_URI | redirect URI on the `/api/StoreGoogleToken` endpoint of this application defined in the Google Calendar API OAuth2.0 access | `https://myfamilyboard.azurewebsites.net/api/StoreGoogleToken` |
| IMAGE_PASSPHRASE | Specifies a string used as passphrase to encrypt the access key to the latest image provided by the ImageServer to the front-end (related to `ENCRYPTION_INITVECTOR`) |
| MSA_CLIENT_ID | client identifier for Microsoft Calendar+OneDrive API OAuth2.0 access | `abdefgh-1234-5678-abcd-1234abcd1234abcd` |
| MSA_CLIENT_SECRET | client secret for Microsoft Calendar+OneDrive API OAuth2.0 access | `shajadsg@*saassashd` |
| MSA_REDIRECT_URI | redirect URI on the `/api/StoreMSAToken` endpoint of this application defined in the Microsoft Calendar+OneDrive API OAuth2.0 access | `https://myfamilyboard.azurewebsites.net/api/StoreMSAToken` |
| ONEDRIVE_FOLDER | folder in OneDrive account to pick images from | `familyboard` |