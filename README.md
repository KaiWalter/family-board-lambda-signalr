# Family or Kitchen Board based on Azure Functions and SignalR

Inspired by the board used in [a post from Scott Hanselman](https://www.hanselman.com/blog/HowToBuildAWallMountedFamilyCalendarAndDashboardWithARaspberryPiAndCheapMonitor.aspx), the web application in this project shows information

- from a Google Calendar
- from an Outlook Calendar
- random images from OneDrive

and is called from a browser on a Rasberry Pi W to display this information in a comprehensive board.

> DISCLAIMER: Looking at the Azure consumption, this app cannot beat the pricing and flexible rendering capabilites of [Dakboard](https://dakboard.com) suggested in the post. It is merely a nice training exercise for me.

## Technologies used

- [Azure (durable) Functions](https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview)
- [SignalR services](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-signalr-service)
- [Static pages hosted in Azure Functions - blog by Anthony Chu](https://anthonychu.ca/post/azure-functions-static-file-server/)
- Symetric encryption [- based on this post- ](https://tekeye.uk/visual_studio/encrypt-decrypt-c-sharp-string) of expiration date/time to protect API endpoint for access the latest availabe image

## Architecture

Front-end is based on static pages which are hosted from Consumption Plan Azure Functions (class `StaticFileServer`).

For basic protection `index.html` can only be opened with a Azure Functions key: `https://{function-app}.azurewebsites.net/index.html?code={function-key}`. All other static content is not protected.

Functions back-end uses Azure SignalR services to communicate board (calendar and image) changes to the web front-end.

### Board update flows

Various flows update the board and are either initiated when the default page `index.htm` is opened, a SignalR client connects or by scheduled timers.

#### Cient connect

When a new SignalR client connects, all contents of the board are updated:

| Function | Function Type |
| ---- | ---- |
| Negotiate | Http Trigger |
| -> FullBoardUpdate | Orchestration |
| - -> CheckConfigurationActivity | Activity Function |
| - -> RefreshGoogleTokenActivity | Activity Function |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> UpdateCalendarActivity | Activity Function |
| - -> RollImageActivity | Activity Function |
| - -> UpdateImageActivity | Activity Function |

#### Scheduled calendar update

Calendar is updated based on a scheduled trigger (e.g. each 5 mins):

| Function | Function Type |
| ---- | ---- |
| ScheduledCalendarUpdate | Trimer Trigger |
| -> CalendarUpdate | Orchestration |
| - -> RefreshGoogleTokenActivity | Activity Function |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> UpdateCalendarActivity | Activity Function |

#### Scheduled image update

Image is updated based on a scheduled trigger (e.g. each 1 mins):

| Function | Function Type |
| ---- | ---- |
| ScheduledImageUpdate | Trimer Trigger |
| -> ImageUpdate | Orchestration |
| - -> RefreshMSATokenActivity | Activity Function |
| - -> RollImageActivity | Activity Function |
| - -> UpdateImageActivity | Activity Function |

### Access to Microsoft & Google APIs

Access to Outlook Calendar, OneDrive and Google Calendar API is handled with OAuth2.0 tokens where the access & refresh token is generated by calling the authorization endpoint and having a function storing the tokens in the associated storage account. Setup section below described how this credentials are setup and wired into the application.

### Endpoint protection

To allow seamless and safe access from browser / front-end to band-end HTTP endpoints, these are protected with these methods:

| endpoint | purpose | protection |
| ---- | ---- | ---- |
| /api/negotiate | SignalR negotiation endpoint | none, AuthorizationLevel.Anonymous |
| GET /index.html | HTTP endpoint for retrieving main page and hence initiating SignalR connection to back-end; proxied to `/api/ProtectedStaticFileServer?file=index.html` | Function key, AuthorizationLevel.Function |
| GET /static/* | HTTP endpoint for retrieving static content like _css_; proxied to `/api/StaticFileServer?file={path}` | none, AuthorizationLevel.Anonymous |
| GET /favicon.ico | HTTP endpoint for retrieving `favicon.ico` (to reduce browser console error messages); proxied to `/api/StaticFileServer?file=favicon.ico` | none, AuthorizationLevel.Anonymous |
| GET /api/ImageServer | HTTP endpoint for front-end to retrieve latest image when signaled from back-end | AuthorizationLevel.Anonymous; protected with a symetric encrypted key / expiration timestamp which back-end signals to front-end and which is only valid a limited time (1 minute) |
| POST /api/UpdateCalendar | REST endpoint to force update of calendar content on the board | Function key, AuthorizationLevel.Function |
| POST /api/UpdateImage | REST endpoint to force update of image on the board | Function key, AuthorizationLevel.Function |
| POST /api/SendMessage | REST endpoint to send a permanent message on the board; JSON body: {"Text":"_message text_" } | Function key, AuthorizationLevel.Function |
| GET /api/Health | REST endpoint to check health and API access tokens; can be used in CI/CD post deployment approval gates for checking deployment/health | Admin Function Key, AuthorizationLevel.Admin |

## Limitations

- currently only fix 3 weeks model
- only German weekdays from Monday to Sunday
- public holidays for Germany, Baden-WÃ¼rttemberg

## Setup runtime environment

> links valid as per June, 2019

1. setup Azure Function App in Consumption Plan and Runtime stack .NET with Application Insights
1. setup Azure SignalR Services in Classic mode
1. get connection string from SignalR Services > Keys and set application setting `AzureSignalRConnectionString` in Azure Functions App
1. setup an application in [Microsoft Application Registration Portal](https://apps.dev.microsoft.com); create an application secret; add a web platform with redirect URI `https://{your-function-app-name}.azurewebsites.net/api/StoreMSAToken`; add Graph permissions `offline_access`, `User.Read`, `Calendars.Read` and `Files.Read.All`; set Functiop App settings `MSA_CLIENT_ID`, `MSA_CLIENT_SECRET` and `MSA_REDIRECT_URI` according to your settings made in Google APIs
1. setup a project in [Google APIs](https://console.developers.google.com/apis); create an OAuth Client ID, for Web Application with redirect URI `https://{your-function-app-name}.azurewebsites.net/api/StoreGoogleToken`; add scope `../auth/calendar.events.readonly` on OAuth consent screen; set Functiop App settings `GOOGLE_CALENDAR_ID`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` and `GOOGLE_REDIRECT_URI` according to your settings made in Google APIs
1. set `ENCRYPTION_INITVECTOR` and `IMAGE_PASSPHRASE` Function App application settings to arbitrary string (e.g. from [random.org](https://www.random.org/strings/?num=2&len=20&digits=on&upperalpha=on&loweralpha=on&unique=on&format=html&rnd=new)) with about 15-20 digits in this regex pattern: `^[A-Za-z0-9]{15,20}$`
1. set `ONEDRIVE_FOLDER` Function App application settings to a folder which is on the first level (root) of your OneDrive account
1. set `SCHEDULEUPDATECALENDAR` and `SCHEDULEUPDATEIMAGE` to desired schedules e.g. `0 */5 * * * *` and `0 */1 * * * *` to update calendar each 5 and image each minute
1. initiate Google token generation with URI https://accounts.google.com/o/oauth2/v2/auth?scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar.events.readonly&access_type=offline&prompt=consent&include_granted_scopes=true&state=state_parameter_passthrough_value&redirect_uri=https%3A%2F%2F{your-function-app-name}.azurewebsites.net%2Fapi%2FStoreGoogleToken&response_type=code&client_id={GOOGLE_CLIENT_ID}
1. initiate Microsoft token generation with URI https://login.live.com/oauth20_authorize.srf?client_id={MSA_CLIENT_ID}&scope=offline_access%20files.read%20calendars.read&response_type=code&redirect_uri=https%3A%2F%2F{your-function-app-name}.azurewebsites.net%2Fapi%2FStoreMSAToken
1. storage account (linked to Function App) should now contain 2 entries for RowKeys `Google` and `MSA` with the recent access tokens
1. note `default` Function/Host key and start board with https://{your-function-app-name}.azurewebsites.net/index.html?code={function-key}
1. check `exceptions` or `dependencies` in Application Insights or browser debugger console for errors

## Setup local environment

> links valid as per June, 2019

1. setup Azure Function App in Consumption Plan and Runtime stack .NET with Application Insights
1. setup Azure SignalR Services in Classic mode
1. execute steps 3. to 8. but use `http://localhost:7071/api/StoreGoogleToken` or `http://localhost:7071/api/StoreMSAToken` as redirect URIs and put all settings in `local.settings.json`
1. initiate Google token generation with URI https://accounts.google.com/o/oauth2/v2/auth?scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar.events.readonly&access_type=offline&prompt=consent&include_granted_scopes=true&state=state_parameter_passthrough_value&redirect_uri=http%3A%2F%2Flocalhost:7071%2Fapi%2FStoreGoogleToken&response_type=code&client_id={GOOGLE_CLIENT_ID}
1. initiate Microsoft token generation with URI https://login.live.com/oauth20_authorize.srf?client_id={MSA_CLIENT_ID}&scope=offline_access%20files.read%20calendars.read&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%3A7071%2Fapi%2FStoreMSAToken
1. development storage account should now contain 2 entries for RowKeys `Google` and `MSA` with the recent access tokens
1. add `Host` value included in the `local.settings.json` sample below
1. start board with http://localhost:7071/index.html
1. check `exceptions` or `dependencies` in Application Insights or browser debugger console for errors

## Application settings overview

Additional to the common Azure Functions settings (`APPINSIGHTS_INSTRUMENTATIONKEY`, `AzureWebJobsStorage`, ...), these settings need to be set in the Azure Functions for the application to work properly:

| App setting | purpose | sample |
| ---- | ---- | ---- |
| AzureSignalRConnectionString | Connection string used by SignalR binding to connect to SignalR service |
| ENCRYPTION_INITVECTOR | Specifies a string used as an initial vector to encrypt the access key to the latest image provided by the ImageServer to the front-end (related to `IMAGE_PASSPHRASE`) |
| GOOGLE_CALENDAR_ID | calender id accessed over Google Calendar API | `john.doe@gmail.com` |
| GOOGLE_CLIENT_ID | client identifier for Google Calendar API OAuth2.0 access | `123456789012-abdefghijklmnopqrstuvwxyz01234567.apps.googleusercontent.com` |
| GOOGLE_CLIENT_SECRET | client secret for Google Calendar API OAuth2.0 access | `12345-AbCdEfGhIjKl-mNoPqRsTuV` |
| GOOGLE_REDIRECT_URI | redirect URI on the `/api/StoreGoogleToken` endpoint of this application defined in the Google Calendar API OAuth2.0 access | `https://myfamilyboard.azurewebsites.net/api/StoreGoogleToken` |
| IMAGE_PASSPHRASE | Specifies a string used as passphrase to encrypt the access key to the latest image provided by the ImageServer to the front-end (related to `ENCRYPTION_INITVECTOR`) |
| MSA_CLIENT_ID | client identifier for Microsoft Calendar+OneDrive API OAuth2.0 access | `abdefgh-1234-5678-abcd-1234abcd1234abcd` |
| MSA_CLIENT_SECRET | client secret for Microsoft Calendar+OneDrive API OAuth2.0 access | `shajadsg@*saassashd` |
| MSA_REDIRECT_URI | redirect URI on the `/api/StoreMSAToken` endpoint of this application defined in the Microsoft Calendar+OneDrive API OAuth2.0 access | `https://myfamilyboard.azurewebsites.net/api/StoreMSAToken` |
| ONEDRIVE_FOLDER | folder in OneDrive account to pick images from | `familyboard` |
| SCHEDULEUPDATECALENDAR | CRON expression for Timer Trigger - update schedule calendar | `0 */5 * * * *` |
| SCHEDULEUPDATEIMAGE | CRON expression for Timer Trigger - update schedule image | `0 */1 * * * *` |

## sample local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "APPINSIGHTS_INSTRUMENTATIONKEY": "{application-insights-instrumentation-key}",
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "AzureSignalRConnectionString": "{signalr-connection-string}",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet",
    "CALENDAR_TIMEZONE": "Europe/Berlin",
    "MSA_CLIENT_ID": "{msa-client-id-from-app-registration}",
    "MSA_CLIENT_SECRET": "{msa-client-secret-from-app-registration}",
    "MSA_REDIRECT_URI": "http://localhost:7071/api/StoreMSAToken",
    "GOOGLE_CALENDAR_ID": "john.doe@gmail.com",
    "GOOGLE_CLIENT_ID": "{google-client-id-from-api-console}",
    "GOOGLE_CLIENT_SECRET": "{google-client-secret-from-api-console}",
    "GOOGLE_REDIRECT_URI": "http://localhost:7071/api/StoreGoogleToken",
    "ENCRYPTION_INITVECTOR": "TdnNMEKvUWzc2Re9R",
    "IMAGE_PASSPHRASE": "LP0E3ED82rXjyES6w",
    "ONEDRIVE_FOLDER": "familyboard"
  },
  "Host": {
    "LocalHttpPort": 7071,
    "CORS": "http://localhost:7071",
    "CORSCredentials": true
  }
}
```

## Links

- frequently check [a CDN for @aspnet/signalr updates](https://www.jsdelivr.com/package/npm/@aspnet/signalr)